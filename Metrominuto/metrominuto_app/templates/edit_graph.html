{% extends "base.html" %}
{% set active_page="edit_graph" %}
{% block content %}
    {{ super() }}
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static', filename='css/show_graph.css') }}">
    <script src="{{ url_for('static', filename='js/snap.svg-min.js') }}"></script>
    <style>
        .static {
            cursor: not-allowed;
        }
        .draggable {
            cursor: move;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>


    <div class="row">
        <div class="col-12">
            <svg id="svgout" version="1.1" xmlns="http://www.w3.org/2000/svg" style="width: 100%;height: 100%;padding-top: 10px;margin-left: auto;margin-right: auto"></svg>
        </div>
    </div>

{% endblock %}
{% block scripts %}
    {{ super() }}
    {#    <script src="{{ url_for('static', filename='js/grafo.js') }}"></script>#}
    <script>
        Snap.plugin(function (Snap, Element, Paper, global, Fragment) {
            function dragStart(x, y, e) {
                this.current_transform = this.transform();
            }

            function dragMove(dx, dy, x, y, e) {
                this.transform(this.current_transform+'T'+dx/1000+','+dy/1000);
                this.updatePaths();
            }

            function dragEnd(e) {
                this.current_transform = this.transform();
            }

            function updatePaths() {
                var key;
                for(key in this.paths) {
                    this.paths[key][0].attr({"path" : this.getPathString(this.paths[key][1])});
                    this.paths[key][0].prependTo(this.paper);
                }
            }

            function getCoordinates() {
                return [this.matrix.e + (this.node.width.baseVal.value / 2),
                    this.matrix.f + (this.node.height.baseVal.value / 2)];
            }

            function getPathString(obj) {
                var p1 = this.getCoordinates();
                var p2 = obj.getCoordinates();
                return "M"+p1[0]+","+p1[1]+"L"+p2[0]+","+p2[1];
            }

            function addPath(obj, color) {
                var id = obj.id;
                var path = this.paper.path(this.getPathString(obj)).attr({fill:'none', stroke:color, strokeWidth:0.009});
                path.prependTo(this.paper);
                this.paths[id] = [path, obj];
                obj.paths[this.id] = [path, this];
            }

            function removePath(obj) {
                var id = obj.id;
                if (this.paths[id] != null) {
                    this.paths[id][0].remove();
                    this.paths[id][1] = null;
                    delete this.paths[id];

                    obj.paths[this.id][1] = null;
                    delete obj.paths[this.id];
                }
            }

            Paper.prototype.draggableRect = function (x, y, w, h) {
                var rect = this.rect(0,0,w,h).transform("T"+x+","+y);
                rect.paths = {};
                rect.drag(dragMove, dragStart, dragEnd);
                rect.updatePaths = updatePaths;
                rect.getCoordinates = getCoordinates;
                rect.getPathString = getPathString;
                rect.addPath = addPath;
                rect.removePath = removePath;
                return rect;
            };

            function getCoordinatesCircle() {
                return [this.matrix.e, this.matrix.f];
            }

            Paper.prototype.draggableCircle = function (x, y, r, id_circle) {
                var circle = this.circle(0, 0, r).attr({id: id_circle}).transform("T"+x+","+y);
                circle.paths = {};
                circle.drag(dragMove, dragStart, dragEnd);
                circle.updatePaths = updatePaths;
                circle.getCoordinates = getCoordinatesCircle;
                circle.getPathString = getPathString;
                circle.addPath = addPath;
                circle.removePath = removePath;
                return circle;
            };

            Paper.prototype.draggableText = function (cx, cy, label,w,h, id_label, label_color) {
                var circle = this.text(0, 0, label).attr({id: id_label, 'font-size':0.025, 'font-weight': 'bold', fill:label_color}).transform("T"+cx+","+cy);
                circle.paths = {};
                circle.drag(dragMove, dragStart, dragEnd);
                circle.updatePaths = updatePaths;
                circle.getCoordinates = getCoordinatesCircle;
                circle.getPathString = getPathString;
                circle.addPath = addPath;
                circle.removePath = removePath;
                return circle;
            };

        });

        var papers = Snap("#svgout");
        papers.attr({viewBox:"0, 0.2, 1, 1.5"});

        var lista = []
        var grafo = {{ grafo|safe }}

        for(var i=0;i<grafo['nodes'].length;i++){
            //lista.push(papers.draggableRect(grafo['nodes'][i][1]['pos'][0],grafo['nodes'][i][1]['pos'][1],0.05,0.05));
            lista.push(papers.draggableCircle(grafo['nodes'][i]['pos'][0],grafo['nodes'][i]['pos'][1],0.02, 'node_'+i.toString()));
        }

        for(var i=0;i<grafo['edges'].length;i++) {
            lista[parseInt(grafo['edges'][i]['edge'][0])].addPath(lista[parseInt(grafo['edges'][i]['edge'][1])], grafo['edges'][i]['color'])
        }

        for(var i=0;i<grafo['labels_nodes'].length;i++) {
            cx =grafo['labels_nodes'][i]['pos'][0];
            cy =grafo['labels_nodes'][i]['pos'][1];
            clabel = grafo['labels_nodes'][i]['label']
            //papers.text(cx, cy, clabel).attr({'font-size':0.025, 'font-weight': 'bold'});
            papers.draggableText(cx, cy, clabel,0.13,0.08, 'label_node'+i.toString(), grafo['labels_nodes'][i]['color']);
        }

        for(var i=0;i<grafo['labels_edges'].length;i++) {
            cx =grafo['labels_edges'][i]['pos'][0];
            cy =grafo['labels_edges'][i]['pos'][1];
            clabel = grafo['labels_edges'][i]['label']
            papers.draggableText(cx, cy, clabel,0.13,0.08, 'label_edge_',  grafo['labels_edges'][i]['color']);
        }
    </script>
{% endblock %}