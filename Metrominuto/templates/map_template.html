{% extends "base_template.html" %}

{% block app_content %}
    <style>
        .row{
            margin-right: 10px;
            margin-left: 10px;
        }
    </style>
{#    <div class="container">#}
        <div class="row">
            <div class="col-12">
                <input id="pac-input"
                       type="text"
                       placeholder="Enter a location">
                <div id="map"></div>
            </div>
        </div>
        <div class="row" id="buttons">
            <input type='button' class="btn btn-primary" value='Delete' id='removeButton'>
            <input type='button' class="btn btn-primary" value='Save' id='saveButton' href="/graph">
{#            <a  class="btn btn-primary btn-lg active" role="button" aria-pressed="true">Save2</a>#}
            <select id="select" class="mdb-select">
                <option value="" disabled selected>Elige Modo Desplazamiento</option>
                <option value="bicycling">Bicicleta</option>
                <option value="walking">A pie</option>
                <option value="driving">Coche</option>
                <option value="transit">Trasporte PÃºblico</option>
            </select>
        </div>
{#    </div>#}

    </body>
{% endblock %}
{% block scripts %}
    <script>
        $(document).ready(function boxes(){
            var directionsService = new google.maps.DirectionsService();
            var directionsRenderer = new google.maps.DirectionsRenderer();
            var markers = [];

            $("#removeButton").click(function () {
                deleteMarkers();
            });

            $("#saveButton").click(function () {
                //alert(markers[0].label);
                var list = []
                for(i=0;i<markers.length;i++){
                    var marcador = {'position' : markers[i].position};
                    list.push(marcador)
                }
                $.ajax({
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    url: "/setMarks",
                    traditional: "true",
                    data: JSON.stringify(list),
                    dataType: "json"
                });
            });
            $("#select").change(function () {
                $.post('/setMode', {
                    mode: $('#select').val()
                }).done(function(response) {
                    {#$(destElem).text(response['text'])#}
                    console.log('OK');
                }).fail(function() {
                    {#$(destElem).text("{{ _('Error: Could not contact server.') }}");#}
                    console.log('ERROR');
                });
            });

            $("#prueba").click(function () {
                var list = []
                for(i=0;i<markers.length;i++){
                    var marcador = {'position' : markers[i].position};
                    list.push(marcador)
                }
                prueb_ajax(JSON.stringify(list));
            });


            function initMap() {
                let myLatLng = {lat: {{latitud}}, lng: {{longitud}} }
                let map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    center: myLatLng
                });

                google.maps.event.addListener(map, 'click', function(event) {
                    addMarker(event.latLng, map);
                });

                directionsRenderer.setMap(map);
                var input = document.getElementById('pac-input');

                var autocomplete = new google.maps.places.Autocomplete(input);
                autocomplete.bindTo('bounds', map);

                // Specify just the place data fields that you need.
                autocomplete.setFields(['place_id', 'geometry', 'name']);

                map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

                var infowindow = new google.maps.InfoWindow();


                var marker = new google.maps.Marker({map: map});

                marker.addListener('click', function() {
                    infowindow.open(map, marker);
                });

                autocomplete.addListener('place_changed', function() {
                    infowindow.close();

                    var place = autocomplete.getPlace();

                    if (!place.geometry) {
                        return;
                    }

                    if (place.geometry.viewport) {
                        map.fitBounds(place.geometry.viewport);
                    } else {
                        map.setCenter(place.geometry.location);
                        map.setZoom(17);
                    }

                    // Set the position of the marker using the place ID and location.
                    marker.setPlace({
                        placeId: place.place_id,
                        location: place.geometry.location
                    });
                    saveMarker(marker);
                    marker.setVisible(true);
                    infowindow.open(map, marker);
                });
            }

            function addMarker(location, map) {
                var geocoder = new google.maps.Geocoder;
                geocoder.geocode({'location': location}, function(results, status) {
                    if (status === google.maps.GeocoderStatus.OK) {
                        if (results[1]) {
                            //console.log(results[0].place_id);
                            var marker = new google.maps.Marker({
                                position: location,
                                map: map
                            });
                            saveMarker(marker);
                            var infowindow = new google.maps.InfoWindow({content: results[0].formatted_address });
                            {#infowindow.open(map,marker);#}
                            marker.addListener('click', function() {
                                infowindow.open(map, marker);
                            });
                        } else {
                            window.alert('No results found');
                        }
                    }
                });
            }


            function saveMarker(mark) {
                markers.push(mark);
            }


            function setMapOnAll(map) {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(map);
                }
            }

            function clearMarkers() {
                setMapOnAll(null);
            }

            // Deletes all markers in the array by removing references to them.
            function deleteMarkers() {
                clearMarkers();
                markers = [];
            }
            google.maps.event.addDomListener(window, 'load', initMap);
        });

        function prueb_ajax(marcadores) {
            {#$(destElem).html('<img src="{{ url_for('static', filemarcadoresname='loading.gif') }}">');#}
            $.post('/pruebajax', {
                text: marcadores
            }).done(function(data) {
                console.log(data);
            }).fail(function(data) {
                console.log(data);
            });
        }
    </script>
{% endblock %}